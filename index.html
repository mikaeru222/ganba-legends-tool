<!-- === GANBA CSV GitHub Uploader Widget (drop-in) === -->
<style>
  .gl-fab{position:fixed;right:16px;bottom:16px;z-index:9999;background:#1677ff;color:#fff;border:none;border-radius:24px;padding:10px 14px;box-shadow:0 6px 20px rgba(0,0,0,.25);cursor:pointer;font-weight:600}
  .gl-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9998}
  .gl-modal{width:min(640px,92vw);background:#111827;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .gl-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .gl-input{flex:1;min-width:140px;background:#0b1220;border:1px solid #22314b;border-radius:8px;color:#e5e7eb;padding:8px 10px}
  .gl-btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:8px 12px;cursor:pointer}
  .gl-btn:hover{background:#2b3647}
  .gl-btn-danger{background:#ef4444;border-color:#dc2626;color:#fff}
  .gl-ok{color:#86efac}.gl-err{color:#fca5a5;white-space:pre-wrap}
  .gl-small{font-size:12px;color:#9ca3af}
</style>
<button class="gl-fab" id="glFab">CSV一括アップロード</button>
<div class="gl-modal-bg" id="glModalBg" aria-hidden="true">
  <div class="gl-modal">
    <h3 style="margin:0 0 8px">CSVをGitHubに上書き</h3>
    <div class="gl-small">画面はそのまま、CSVだけを <b>GitHubの指定パス</b> に上書きします。トークンは保存しません。</div>
    <div class="gl-row">
      <input id="glOwner" class="gl-input" placeholder="owner 例: mikaeru222">
      <input id="glRepo"  class="gl-input" placeholder="repo 例: ganba-legends-tool">
      <input id="glBranch"class="gl-input" placeholder="branch" value="main" style="max-width:160px">
    </div>
    <div class="gl-row">
      <input id="glPath"  class="gl-input" placeholder="path 例: test_patterns_full.csv" value="test_patterns_full.csv">
    </div>
    <div class="gl-row">
      <input id="glToken" class="gl-input" type="password" placeholder="GitHub Personal Access Token（repo権限）">
    </div>
    <div class="gl-row">
      <input id="glMsg"   class="gl-input" placeholder="commit message" value="update csv via admin upload">
    </div>
    <div class="gl-row">
      <input id="glFile" type="file" accept=".csv" class="gl-input" style="border:none;padding:6px 0;background:transparent">
      <button id="glPush" class="gl-btn gl-btn-danger">GitHubに上書きアップロード</button>
      <button id="glClose" class="gl-btn">閉じる</button>
    </div>
    <div id="glStatus" class="gl-small" style="margin-top:6px"></div>
  </div>
</div>
<script>
(function(){
  const $=q=>document.querySelector(q);
  const fab=$("#glFab"), bg=$("#glModalBg"), pushBtn=$("#glPush"), closeBtn=$("#glClose");
  const owner=$("#glOwner"), repo=$("#glRepo"), branch=$("#glBranch"), path=$("#glPath");
  const token=$("#glToken"), msg=$("#glMsg"), file=$("#glFile"), status=$("#glStatus");

  fab.onclick=()=>{ bg.style.display='flex'; };
  closeBtn.onclick=()=>{ bg.style.display='none'; status.textContent=''; file.value=''; };

  async function getSha(owner,repo,path,branch,token){
    const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const res=await fetch(url, {headers:{Authorization:`token ${token}`,Accept:"application/vnd.github+json"}});
    if(res.ok){ const j=await res.json(); return j.sha||null; }
    return null; // 新規作成はOK
  }
  function b64(txt){ return btoa(unescape(encodeURIComponent(txt))); }
  function toast(t, ok=true){ status.innerHTML = (ok? "<span class='gl-ok'>":"<span class='gl-err'>")+t+"</span>"; }

  pushBtn.onclick=async()=>{
    try{
      const ow=(owner.value||"").trim(), rp=(repo.value||"").trim(), br=(branch.value||"main").trim()||"main";
      const p =(path.value||"").trim(), tk=(token.value||"").trim(), m=(msg.value||"update").trim();
      if(!ow||!rp||!p||!tk){ toast("owner/repo/path/token を入力してください", false); return; }
      const f=file.files&&file.files[0]; if(!f){ toast("CSVファイルを選択してください", false); return; }
      toast("アップロード中…");
      const text=await f.text();
      const sha=await getSha(ow,rp,p,br,tk);
      const body={message:m, content:b64(text), branch:br}; if(sha) body.sha=sha;
      const res=await fetch(`https://api.github.com/repos/${ow}/${rp}/contents/${encodeURIComponent(p)}`, {
        method:"PUT", headers:{Authorization:`token ${tk}`,Accept:"application/vnd.github+json"}, body:JSON.stringify(body)
      });
      if(!res.ok){ const t=await res.text(); throw new Error(t); }
      const raw=`https://raw.githubusercontent.com/${ow}/${rp}/${br}/${p}`;
      toast("完了：GitHubに上書きしました。Raw: "+raw+"  ページは再読込で反映されます。", true);
    }catch(e){ toast("失敗: "+e.message, false); }
  };
})();
</script>
<!-- === /GANBA CSV GitHub Uploader Widget === -->
