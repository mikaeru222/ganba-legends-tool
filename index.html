<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カードゲームツール｜運用＋管理（GitHub連携）</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1530; --muted:#8ea0c0; --text:#eaf0ff; --brand:#5aa5ff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --ring:rgba(90,165,255,.35);
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0b1020,#091427 60%,#081024);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", Meiryo, sans-serif;
      color:var(--text);
    }
    .container{max-width:980px;margin:24px auto;padding:16px}
    .card{background:linear-gradient(180deg,#0f1530 0 60%, #0c1229);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .card-inner{padding:18px 18px 22px}
    header.top{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#8bd0ff,#5aa5ff 40%,#3163ff 100%);box-shadow:0 0 0 4px rgba(90,165,255,.15)}
    .brand h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .tabs{display:flex;gap:6px;background:rgba(255,255,255,.04);padding:6px;border-radius:12px}
    .tab{padding:8px 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;user-select:none}
    .tab.active{background:rgba(90,165,255,.12);border-color:rgba(90,165,255,.35);box-shadow:inset 0 0 0 1px rgba(90,165,255,.15)}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns: 1fr; gap:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .input, select, button{background:#0a1128;border:1px solid rgba(255,255,255,.08);color:var(--text);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    .input:focus, select:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    button{cursor:pointer}
    .btn{background:linear-gradient(180deg,#1a2b57,#132246);border:1px solid rgba(90,165,255,.3)}
    .btn:hover{filter:brightness(1.08)}
    .btn.ghost{background:transparent}
    .btn.brand{background:linear-gradient(180deg,#3a79ff,#2b5be9);border:1px solid rgba(49,99,255,.6)}
    .btn.ok{background:linear-gradient(180deg,#12c885,#10a56f);border-color:rgba(16,185,129,.6)}
    .btn.warn{background:linear-gradient(180deg,#f9b64c,#e49a15);border-color:rgba(245,158,11,.6);color:#1a1200}
    .btn.danger{background:linear-gradient(180deg,#ff6b6b,#ef4444)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-weight:600;color:#cbd8f7;text-align:left;font-size:12px;padding:0 8px}
    .table td{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:8px;border-left:none;border-right:none}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px}
    .badge.a{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.45)}
    .badge.b{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.45)}
    .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px}
    .help{font-size:12px;color:#b7c5ea}
    .sep{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:10px 0}
    .center-wrap{display:flex;justify-content:center}
    .content-narrow{width:min(860px,92vw)}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);}
    .hidden{display:none}
  </style>
  <!-- CSV, ZIP utilities -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="center-wrap"><div class="content-narrow card"><div class="card-inner">
      <header class="top">
        <div class="brand">
          <div class="dot"></div>
          <h1>カードゲームツール</h1>
          <span class="muted">検索＋管理（GitHub連携／CSV一括）</span>
        </div>
        <div class="tabs" role="tablist" aria-label="モード切替">
          <div id="tab-run" class="tab active" role="tab" aria-selected="true">運用モード</div>
          <div id="tab-admin" class="tab" role="tab" aria-selected="false">管理者モード</div>
        </div>
      </header>

      <!-- 運用モード（従来どおり） -->
      <section id="run-section" class="grid" aria-labelledby="tab-run">
        <div class="panel">
          <div class="row">
            <input id="q" class="input" placeholder="カード番号やコードを入力（例: A023 / P07-B-076 / 76b）" style="flex:1" />
            <select id="filter-pattern">
              <option value="">パターン（すべて）</option>
              <option>01</option><option>02</option><option>03</option><option>04</option><option>05</option>
              <option>06</option><option>07</option><option>08</option><option>09</option><option>10</option>
              <option>11</option><option>12</option>
            </select>
            <select id="filter-cylinder">
              <option value="">シリンダー（A/B）</option>
              <option value="A">A</option><option value="B">B</option>
            </select>
            <button id="btn-clear" class="btn ghost">クリア</button>
          </div>
          <div class="help">読み込み済みデータ：<span id="data-count">0</span> 件 ｜ データソース：<span id="source-label" class="pill">ローカル</span></div>
        </div>

        <div class="panel">
          <table class="table" aria-describedby="res-info">
            <thead>
              <tr><th>パターン</th><th>シリンダー</th><th>番号</th><th>コード</th><th>備考</th></tr>
            </thead>
            <tbody id="result-body"></tbody>
          </table>
          <div id="res-info" class="help">該当 <span id="hit-count">0</span> 件</div>
        </div>

        <div class="panel">
          <div class="row">
            <button id="btn-export-json" class="btn">ローカルデータをJSONで保存</button>
            <button id="btn-reload-remote" class="btn brand">リモートを同期</button>
            <button id="btn-reset-local" class="btn danger">ローカルデータ初期化</button>
          </div>
          <div class="help">※ リモート同期先は管理者モードで設定します。GitHubの raw JSON を配信先にできます。</div>
        </div>
      </section>

      <!-- 管理者モード -->
      <section id="admin-section" class="grid hidden" aria-labelledby="tab-admin">
        <!-- ログイン -->
        <div id="admin-logged-out" class="panel">
          <div style="font-weight:700">管理者ログイン</div>
          <div class="help">アップロード・設定は管理者のみ操作できます。初期コードは <b>admin123</b></div>
          <div class="row" style="margin-top:8px">
            <input type="password" id="admin-pass" class="input" placeholder="パスコード" style="flex:1" />
            <button id="btn-admin-login" class="btn brand">ログイン</button>
          </div>
        </div>

        <div id="admin-logged-in" class="hidden">
          <!-- CSV群 -->
          <div class="panel">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">管理者メニュー</div>
                <div class="help">CSVヘッダ：pattern(01-12), cylinder(A/B), card_no(001-100), label(任意)</div>
              </div>
              <div class="row"><button id="btn-admin-logout" class="btn ghost">ログアウト</button></div>
            </div>

            <div class="row" style="margin-top:6px">
              <input type="file" id="file-csv" accept=".csv" multiple class="input" />
              <button id="btn-import" class="btn ok">CSV読み込み</button>
              <button id="btn-save-local" class="btn brand">ローカル保存</button>
              <button id="btn-clear-staged" class="btn ghost">未保存を破棄</button>
            </div>
            <div class="help">読み込み済み（未保存）：<span id="import-count">0</span> 件</div>
            <div class="sep"></div>
            <div class="row">
              <button id="btn-gen-templates" class="btn warn">12パターンCSVを生成（ZIP）</button>
            </div>
          </div>

          <!-- 配信先（従来のリモートURL） -->
          <div class="panel">
            <div style="font-weight:700;margin-bottom:6px">配信（リモート）設定</div>
            <div class="row">
              <input id="remote-url" class="input" placeholder="https://raw.githubusercontent.com/USER/REPO/branch/data/cards.json" style="flex:1" />
              <label class="row" style="gap:6px"><input type="checkbox" id="remote-auto" /> 自動同期</label>
              <button id="btn-save-remote" class="btn">保存</button>
            </div>
            <div class="help">ここで設定した JSON を各端末が参照します。GitHub連携を使うと自動設定できます。</div>
          </div>

          <!-- ★ GitHub 連携（NEW） -->
          <div class="panel">
            <div style="font-weight:700;margin-bottom:6px">GitHub連携（一括CSVの取り込み後、このボタンで公開）</div>
            <div class="row">
              <input id="gh-owner" class="input" placeholder="owner（例：mikaeru222）" />
              <input id="gh-repo"  class="input" placeholder="repo（例：ganba-legends-tool）" />
              <input id="gh-branch" class="input" placeholder="branch（例：main）" value="main" />
            </div>
            <div class="row">
              <input id="gh-path" class="input" placeholder="保存パス（例：data/cards.json）" value="data/cards.json" style="flex:1" />
            </div>
            <div class="row">
              <input id="gh-token" class="input" placeholder="GitHub Personal Access Token（repo 権限）" type="password" style="flex:1" />
            </div>
            <div class="row">
              <button id="btn-gh-save" class="btn">設定を保存</button>
              <button id="btn-gh-publish" class="btn brand">GitHubに公開（JSONコミット）</button>
              <button id="btn-gh-fetch" class="btn ghost">GitHubから取得 → ローカル保存</button>
            </div>
            <div class="help">※ ブラウザの localStorage に設定とトークンを保存します。共同PCでは使用しないでください。</div>
          </div>

          <!-- 管理者設定 -->
          <div class="panel">
            <div style="font-weight:700;margin-bottom:6px">管理者設定</div>
            <div class="row">
              <input type="password" id="admin-pass-new" class="input" placeholder="新しいパスコード（任意）" />
              <button id="btn-change-pass" class="btn">パスコード変更</button>
              <button id="btn-wipe-all" class="btn danger">全データ初期化</button>
            </div>
          </div>
        </div>
      </section>

    </div></div></div>
  </div>

<script>
(function(){
  // --- Storage Keys
  const KEY_DB = 'carddb/v1';
  const KEY_REMOTE = 'carddb/remote';
  const KEY_ADMIN = 'carddb/admin';
  const KEY_GH = 'carddb/github';

  // --- State
  let staged = []; // 管理側で読み込んだ未保存データ
  let db = [];     // 実運用データ

  // --- Util
  const $ = (s)=>document.querySelector(s);
  const pad2 = (n)=> String(n).padStart(2,'0');
  const pad3 = (n)=> String(n).padStart(3,'0');
  const norm = (s)=> (s??'').toString().trim();
  const toast = (m)=> alert(m);

  // --- DB I/O
  function loadLocal(){
    try{ db = JSON.parse(localStorage.getItem(KEY_DB) || '[]'); }catch{ db=[]; }
    $('#data-count').textContent = db.length;
  }
  function saveLocal(next){
    db = next;
    localStorage.setItem(KEY_DB, JSON.stringify(db));
    $('#data-count').textContent = db.length;
  }

  // --- Admin settings
  function loadAdmin(){
    const def={pass:'admin123',remoteUrl:'',remoteAuto:false};
    try{ return Object.assign(def, JSON.parse(localStorage.getItem(KEY_ADMIN)||'{}')); }catch{ return def; }
  }
  function saveAdmin(a){ localStorage.setItem(KEY_ADMIN, JSON.stringify(a)); }

  function getRemote(){ try{ return Object.assign({url:'',auto:false}, JSON.parse(localStorage.getItem(KEY_REMOTE)||'{}')); }catch{ return {url:'',auto:false}; } }
  function setRemote(url, auto){ localStorage.setItem(KEY_REMOTE, JSON.stringify({url,auto})); updateSourceLabel(); }

  // --- GitHub settings
  function loadGH(){
    const def={owner:'',repo:'',branch:'main',path:'data/cards.json',token:''};
    try{ return Object.assign(def, JSON.parse(localStorage.getItem(KEY_GH)||'{}')); }catch{ return def; }
  }
  function saveGH(v){ localStorage.setItem(KEY_GH, JSON.stringify(v)); }

  // --- UI helpers
  function updateSourceLabel(){
    const r=getRemote();
    $('#source-label').textContent = r.url ? 'リモート＋ローカル' : 'ローカル';
  }
  function renderRows(rows){
    const tb = $('#result-body'); tb.innerHTML='';
    const frag = document.createDocumentFragment();
    rows.slice(0,500).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge">P${r.pattern}</span></td>
        <td><span class="badge ${r.cylinder==='A'?'a':'b'}">${r.cylinder}</span></td>
        <td>${r.card_no}</td>
        <td class="help">${r.code}</td>
        <td>${(r.label||'')}</td>`;
      frag.appendChild(tr);
    });
    tb.appendChild(frag);
    $('#hit-count').textContent = rows.length;
  }

  // --- CSV normalize
  function normalizeRow(r){
    const p = norm(r.pattern).replace(/^(?:p|P)/,'');
    const pattern = pad2(parseInt(p||'0',10));
    if(!(+pattern>=1 && +pattern<=12)) return null;
    let cylinder = norm(r.cylinder).toUpperCase();
    if(!(cylinder==='A'||cylinder==='B')) return null;
    let n = norm(r.card_no).replace(/\\D/g,'');
    const card_no = pad3(parseInt(n||'0',10));
    if(!(+card_no>=1 && +card_no<=100)) return null;
    const label = norm(r.label);
    const code = `P${pattern}-${cylinder}-${card_no}`;
    return {pattern,cylinder,card_no,label,code};
  }

  function parseCsvFiles(fileList, done){
    if(!fileList || !fileList.length){ toast('CSVファイルを選択してください'); return; }
    let remain=fileList.length, all=[];
    [...fileList].forEach(file=>{
      Papa.parse(file,{header:true, skipEmptyLines:true,
        complete:(res)=>{
          const rows=(res.data||[]).map(normalizeRow).filter(Boolean);
          all=all.concat(rows); remain--; if(remain===0) done(all);
        },
        error:()=>{ remain--; if(remain===0) done(all); }
      });
    });
  }

  // --- Search
  function queryToFilter(q){
    q=(q||'').toString().trim().toUpperCase();
    if(!q) return {};
    const m = q.match(/P?(\\d{1,2})?\\s*[- ]?\\s*([AB])?\\s*[- ]?\\s*(\\d{1,3})?/i);
    let pattern = m && m[1] ? pad2(m[1]) : '';
    let cylinder = m && m[2] ? m[2].toUpperCase() : '';
    let card_no = m && m[3] ? pad3(m[3]) : '';
    if(!cylinder){
      const tail=q.match(/([AB])$/); if(tail) cylinder=tail[1].toUpperCase();
    }
    return {pattern,cylinder,card_no};
  }
  function search(){
    const q=$('#q').value;
    const f=queryToFilter(q);
    const pat=$('#filter-pattern').value || f.pattern;
    const cyl=$('#filter-cylinder').value || f.cylinder;
    const no=f.card_no;
    let rows=db;
    if(pat) rows=rows.filter(r=>r.pattern===pat);
    if(cyl) rows=rows.filter(r=>r.cylinder===cyl);
    if(no)  rows=rows.filter(r=>r.card_no===no);
    renderRows(rows);
  }

  // --- Remote sync
  async function syncRemote(){
    const r=getRemote();
    if(!r.url){ toast('リモートURLが未設定です（管理者モードで設定）'); return; }
    try{
      const res=await fetch(r.url,{cache:'no-store'}); if(!res.ok) throw new Error(res.statusText);
      const json=await res.json(); if(!Array.isArray(json)) throw new Error('JSON配列ではありません');
      const map=new Map(db.map(x=>[x.code,x])); json.forEach(x=>{ if(x&&x.code) map.set(x.code,x); });
      const merged=[...map.values()];
      saveLocal(merged);
      toast(`リモート同期完了：${json.length} 件 / 総計 ${merged.length} 件`);
      search();
    }catch(e){ toast('同期に失敗しました：'+e.message); }
  }

  // --- GitHub API helpers
  function getGHHeaders(token){
    return {
      'Authorization': 'token '+token,
      'Accept': 'application/vnd.github+json',
      'Content-Type': 'application/json'
    };
  }
  function b64(str){
    // UTF-8 → base64
    return btoa(unescape(encodeURIComponent(str)));
  }
  async function ghGetContent(owner,repo,path,branch,token){
    const u=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const r=await fetch(u,{headers:getGHHeaders(token)});
    if(r.status===404) return null;
    if(!r.ok) throw new Error('GitHub API error '+r.status);
    return await r.json(); // {sha, content(base64), ...}
  }
  async function ghPutContent(owner,repo,path,branch,token,content, message, sha){
    const u=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body={message, content:b64(content), branch}; if(sha) body.sha=sha;
    const r=await fetch(u,{method:'PUT', headers:getGHHeaders(token), body:JSON.stringify(body)});
    if(!r.ok){ const t=await r.text(); throw new Error('GitHub PUT失敗：'+t); }
    return await r.json();
  }

  // --- Init
  function init(){
    // tabs
    $('#tab-run').addEventListener('click',()=>activateTab('run'));
    $('#tab-admin').addEventListener('click',()=>activateTab('admin'));

    // run
    loadLocal(); updateSourceLabel(); renderRows(db.slice(0,50)); search();
    $('#q').addEventListener('input',search);
    $('#filter-pattern').addEventListener('change',search);
    $('#filter-cylinder').addEventListener('change',search);
    $('#btn-clear').addEventListener('click',()=>{ $('#q').value=''; $('#filter-pattern').value=''; $('#filter-cylinder').value=''; search(); });
    $('#btn-export-json').addEventListener('click',()=> saveAs(new Blob([JSON.stringify(db,null,2)],{type:'application/json'}),'cards.json'));
    $('#btn-reload-remote').addEventListener('click',syncRemote);
    $('#btn-reset-local').addEventListener('click',()=>{ if(confirm('ローカル保存のカードデータを全て削除します。よろしいですか？')){ saveLocal([]); renderRows([]); search(); }});

    // admin
    requireLogin();
    $('#btn-admin-login').addEventListener('click',()=>login($('#admin-pass').value));
    $('#btn-admin-logout').addEventListener('click',logout);

    // CSV取り込み
    $('#btn-import').addEventListener('click',()=>{
      parseCsvFiles($('#file-csv').files,(rows)=>{
        staged=rows; $('#import-count').textContent=staged.length; toast(`読み込み完了：${staged.length} 件`);
      });
    });
    $('#btn-save-local').addEventListener('click',()=>{
      if(!staged.length){ toast('読み込みデータがありません'); return; }
      const map=new Map(db.map(x=>[x.code,x])); staged.forEach(x=>map.set(x.code,x));
      const merged=[...map.values()];
      saveLocal(merged); staged=[]; $('#import-count').textContent='0'; search();
      toast('ローカル保存しました');
    });
    $('#btn-clear-staged').addEventListener('click',()=>{ staged=[]; $('#import-count').textContent='0'; });

    // CSVテンプレZIP
    $('#btn-gen-templates').addEventListener('click',generateAllPatterns);

    // Remote設定
    const a = loadAdmin();
    $('#remote-url').value = a.remoteUrl||'';
    $('#remote-auto').checked = !!a.remoteAuto;
    if(a.remoteUrl){ setRemote(a.remoteUrl, !!a.remoteAuto); }
    if(a.remoteAuto && a.remoteUrl){ syncRemote(); }
    $('#btn-save-remote').addEventListener('click',()=>{
      const url=$('#remote-url').value.trim(), auto=$('#remote-auto').checked;
      const a2=loadAdmin(); a2.remoteUrl=url; a2.remoteAuto=auto; saveAdmin(a2); setRemote(url,auto); toast('リモート設定を保存しました');
    });

    // GitHub連携UI初期化
    const gh=loadGH();
    $('#gh-owner').value=gh.owner; $('#gh-repo').value=gh.repo; $('#gh-branch').value=gh.branch; $('#gh-path').value=gh.path; $('#gh-token').value=gh.token;
    $('#btn-gh-save').addEventListener('click',()=>{
      const v={owner:$('#gh-owner').value.trim(), repo:$('#gh-repo').value.trim(), branch:$('#gh-branch').value.trim()||'main', path:$('#gh-path').value.trim()||'data/cards.json', token:$('#gh-token').value.trim()};
      saveGH(v); toast('GitHub設定を保存しました');
    });
    $('#btn-gh-publish').addEventListener('click', ghPublish);
    $('#btn-gh-fetch').addEventListener('click', ghFetchIntoLocal);
  }

  // --- CSVテンプレ生成（ZIP）
  function generateAllPatterns(){
    const zip = new JSZip();
    for(let p=1;p<=12;p++){
      const pattern=pad2(p);
      const rows=['pattern,cylinder,card_no,label'];
      ['A','B'].forEach(C=>{
        const nums=Array.from({length:100},(_,i)=>pad3(i+1));
        for(let i=nums.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [nums[i],nums[j]]=[nums[j],nums[i]]; }
        nums.forEach(n=> rows.push(`${pattern},${C},${n},`));
      });
      zip.file(`pattern_${pattern}.csv`, rows.join('\\n'));
    }
    zip.generateAsync({type:'blob'}).then(blob=> saveAs(blob, `card_patterns_12csv_${Date.now()}.zip`));
  }

  // --- GitHub publish/fetch
  async function ghPublish(){
    const gh=loadGH();
    if(!gh.owner||!gh.repo||!gh.branch||!gh.path||!gh.token){ toast('GitHub設定を入力して保存してください'); return; }
    try{
      // 既存SHAを取得（無ければnull）
      const current = await ghGetContent(gh.owner, gh.repo, gh.path, gh.branch, gh.token);
      const sha = current && current.sha;
      // JSON本文
      const payload = JSON.stringify(db, null, 2);
      await ghPutContent(gh.owner, gh.repo, gh.path, gh.branch, gh.token, payload, 'feat: cards.json を更新（ツールから自動公開）', sha);
      // Raw URL を自動設定
      const raw = `https://raw.githubusercontent.com/${gh.owner}/${gh.repo}/${gh.branch}/${gh.path}`;
      const a=loadAdmin(); a.remoteUrl = raw; a.remoteAuto = false; saveAdmin(a); setRemote(raw,false);
      $('#remote-url').value = raw;
      toast('GitHub公開に成功しました。配信先URLを自動設定しました。運用端末は「リモートを同期」で反映されます。');
    }catch(e){ toast('GitHub公開エラー：'+e.message); }
  }

  async function ghFetchIntoLocal(){
    const gh=loadGH();
    if(!gh.owner||!gh.repo||!gh.branch||!gh.path){ toast('GitHub設定が不足しています'); return; }
    // Raw から取得（トークン不要）
    const raw = `https://raw.githubusercontent.com/${gh.owner}/${gh.repo}/${gh.branch}/${gh.path}`;
    try{
      const r=await fetch(raw,{cache:'no-store'}); if(!r.ok) throw new Error(r.statusText);
      const arr=await r.json(); if(!Array.isArray(arr)) throw new Error('配列JSONではありません');
      const map=new Map(db.map(x=>[x.code,x])); arr.forEach(x=>{ if(x&&x.code) map.set(x.code,x); });
      saveLocal([...map.values()]);
      // 配信先も自動でそのRawにあわせる
      const a=loadAdmin(); a.remoteUrl=raw; saveAdmin(a); setRemote(raw, a.remoteAuto||false); $('#remote-url').value=raw;
      toast(`GitHubから取り込みました（${arr.length}件）。`);
      search();
    }catch(e){ toast('GitHub取得エラー：'+e.message); }
  }

  // --- Tab & Auth
  function activateTab(which){
    if(which==='run'){
      $('#tab-run').classList.add('active'); $('#tab-admin').classList.remove('active');
      $('#run-section').classList.remove('hidden'); $('#admin-section').classList.add('hidden');
    }else{
      $('#tab-admin').classList.add('active'); $('#tab-run').classList.remove('active');
      $('#admin-section').classList.remove('hidden'); $('#run-section').classList.add('hidden');
    }
  }
  function isLoggedIn(){ return sessionStorage.getItem(KEY_ADMIN+':in')==='1'; }
  function requireLogin(){
    const logged=isLoggedIn();
    $('#admin-logged-out').classList.toggle('hidden', logged);
    $('#admin-logged-in').classList.toggle('hidden', !logged);
  }
  function login(pass){
    const a=loadAdmin();
    if(pass===a.pass){ sessionStorage.setItem(KEY_ADMIN+':in','1'); requireLogin(); toast('管理者ログインしました'); }
    else { toast('パスコードが違います'); }
  }
  function logout(){ sessionStorage.removeItem(KEY_ADMIN+':in'); requireLogin(); }

  // --- Boot
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
