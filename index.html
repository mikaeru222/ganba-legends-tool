<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ガンバレジェンズ 管理ツール（管理画面で一括CSVアップロード）</title>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --text:#e8eaed; --muted:#a3a6ad;
    --border:#2a2f3a; --accent:#4f8cff; --accent-2:#7bd88f; --danger:#ff6b6b;
    --btn-bg:#1d2430; --btn-bg-hover:#263042;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";line-height:1.6}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,17,21,.97),rgba(15,17,21,.92));backdrop-filter:saturate(1.2) blur(4px);border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:20px;font-weight:650}
  .muted{color:var(--muted);font-size:13px;margin-top:4px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type="text"], input[type="password"], input[type="number"], select{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
  button{cursor:pointer;background:var(--btn-bg);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px 14px}
  button:hover{background:var(--btn-bg-hover)}
  .btn-accent{border-color:transparent;background:var(--accent)}
  .btn-green{border-color:transparent;background:var(--accent-2);color:#0a0f14}
  .btn-danger{border-color:transparent;background:var(--danger)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:16px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:14px}
  th{color:#cfd3da;text-align:left}
  .ok{color:#7bd88f}.err{color:#ff9aa2;white-space:pre-wrap}
  .pill{display:inline-block;background:#1f2633;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;color:#cfd3da}
  @media (max-width: 820px){ .wrap{padding:12px} .row{gap:8px} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ガンバレジェンズ 管理ツール</h1>
    <div class="muted">管理者モードの画面内で <b>一括CSVアップロード</b> ができます。<span class="pill">pattern,cylinder,position,id,rarity</span></div>
  </div>
</header>

<main class="wrap">
  <!-- CSV設定（表示側） -->
  <div class="card">
    <div class="row">
      <label for="rawUrl"><strong>CSV Raw URL（読取用）</strong></label>
      <input id="rawUrl" type="text" placeholder="https://raw.githubusercontent.com/.../main/xxx.csv"
        value="https://raw.githubusercontent.com/mikaeru222/ganba-legends-tool/main/test_patterns_full.csv"/>
      <button id="reloadBtn" class="btn-accent">最新を再読込</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="message" class="muted" style="margin-top:8px;"></div>

    <h3 style="margin-top:12px;">プレビュー（先頭100行）</h3>
    <div id="preview"></div>
  </div>

  <!-- 管理者モード -->
  <div class="card">
    <div class="row">
      <div class="pill">管理者モード</div>
      <input id="adminPass" type="password" placeholder="管理パスワード"/>
      <button id="btnLogin" class="btn-accent">ログイン</button>
      <span id="loginStatus" class="muted"></span>
    </div>

    <div id="adminArea" style="display:none">
      <h3 style="margin-top:8px;">① 一括CSVアップロード（この画面に即反映）</h3>
      <div class="row">
        <input id="filePicker" type="file" accept=".csv"/>
        <button id="btnApplyLocal" class="btn-green">このCSVを画面に反映</button>
      </div>
      <div class="muted">※これは <b>この端末の画面内だけの反映</b> です。他の端末へ共有したい場合は、下の②でGitHubへ上書きしてください。</div>

      <h3 style="margin-top:16px;">② GitHubへ上書きアップロード（任意・安全に取扱）</h3>
      <div class="muted">GitHubの <b>Contents API</b> を使って、CSVをリポジトリに上書きします。トークンはこの画面内だけで使い、保存しません。</div>
      <div class="row" style="margin-top:8px;">
        <input id="ghOwner" type="text" placeholder="owner（例: mikaeru222）" value="mikaeru222"/>
        <input id="ghRepo" type="text" placeholder="repo（例: ganba-legends-tool）" value="ganba-legends-tool"/>
        <input id="ghBranch" type="text" placeholder="branch" value="main"/>
        <input id="ghPath" type="text" placeholder="path（例: test_patterns_full.csv）" value="test_patterns_full.csv"/>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="ghToken" type="password" placeholder="GitHub Personal Access Token（repo権限）"/>
        <input id="ghMessage" type="text" placeholder="commit message" value="update csv via admin panel"/>
        <button id="btnPush" class="btn-danger">GitHubに上書きアップロード</button>
      </div>
      <div id="pushStatus" class="muted"></div>
    </div>
  </div>
</main>

<script>
/* ====== 簡易状態 ====== */
const ADMIN_PASSWORD = "LEGENDS2025"; // 公開前に変更してください
const $ = (q)=>document.querySelector(q);
const els = {
  rawUrl: $("#rawUrl"), reloadBtn: $("#reloadBtn"), status: $("#status"), message: $("#message"),
  preview: $("#preview"),
  adminPass: $("#adminPass"), btnLogin: $("#btnLogin"), loginStatus: $("#loginStatus"),
  adminArea: $("#adminArea"), filePicker: $("#filePicker"), btnApplyLocal: $("#btnApplyLocal"),
  ghOwner: $("#ghOwner"), ghRepo: $("#ghRepo"), ghBranch: $("#ghBranch"), ghPath: $("#ghPath"),
  ghToken: $("#ghToken"), ghMessage: $("#ghMessage"), btnPush: $("#btnPush"), pushStatus: $("#pushStatus"),
};

let latestCSVText = ""; // 直近で読み込んだCSVテキスト（GitHub or ローカル）

/* ====== 起動・再読込 ====== */
document.addEventListener("DOMContentLoaded", ()=>autoLoadFromGitHub());
els.reloadBtn.addEventListener("click", ()=>autoLoadFromGitHub(true));

async function autoLoadFromGitHub(){
  const baseUrl=(els.rawUrl.value||"").trim();
  if(!baseUrl){ setError("Raw URL を入力してください。"); return; }
  const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
  setStatus("GitHubから取得中…");
  try{
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    latestCSVText = text;
    renderPreview(parseCSV(text));
    setStatus("GitHubから最新を取得しました", true);
  }catch(e){ setError("CSVの取得に失敗しました。\\n" + e.message); }
}

/* ====== 管理ログイン ====== */
els.btnLogin.addEventListener("click", ()=>{
  if(els.adminPass.value === ADMIN_PASSWORD){
    els.loginStatus.textContent = "管理者ログインOK";
    els.adminArea.style.display = "block";
  }else{
    els.loginStatus.textContent = "パスワードが違います";
  }
});

/* ====== ① 画面内に一括反映（ローカル） ====== */
els.btnApplyLocal.addEventListener("click", async ()=>{
  const file = els.filePicker.files?.[0];
  if(!file){ alert("CSVファイルを選択してください"); return; }
  try{
    const text = await file.text();
    latestCSVText = text;
    renderPreview(parseCSV(text));
    toast("CSVを画面に反映しました（この端末のみ）");
  }catch(e){
    setError("ローカルCSVの読み込みに失敗しました。\\n" + e.message);
  }finally{
    els.filePicker.value = "";
  }
});

/* ====== ② GitHubに上書きアップロード（任意） ====== */
els.btnPush.addEventListener("click", async ()=>{
  if(!latestCSVText){ alert("先にCSVを読み込んでください（GitHubから読込 or ①で反映）"); return; }
  const owner=(els.ghOwner.value||"").trim();
  const repo =(els.ghRepo.value||"").trim();
  const branch=(els.ghBranch.value||"main").trim()||"main";
  const path  =(els.ghPath.value||"").trim();
  const token =(els.ghToken.value||"").trim();
  const message=(els.ghMessage.value||"update csv via admin panel").trim();
  if(!owner || !repo || !path || !token){ alert("owner/repo/path/token を入力してください"); return; }

  els.pushStatus.textContent = "GitHubにアップロード中…";
  try{
    // 1) 既存SHA取得（新規の場合は404を許容）
    let sha = null;
    const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, {
      headers: { "Authorization": `token ${token}`, "Accept":"application/vnd.github+json" }
    });
    if(getRes.ok){
      const info = await getRes.json();
      sha = info.sha;
    }

    // 2) PUTでアップデート
    const contentB64 = btoa(unescape(encodeURIComponent(latestCSVText)));
    const body = { message, content: contentB64, branch };
    if(sha) body.sha = sha;

    const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
      method:"PUT",
      headers:{ "Authorization": `token ${token}`, "Accept":"application/vnd.github+json" },
      body: JSON.stringify(body)
    });

    if(!putRes.ok){
      const t = await putRes.text();
      throw new Error("アップロード失敗: " + t);
    }

    els.pushStatus.innerHTML = "<span class='ok'>GitHubに上書きしました。</span> 反映後は公開ページを再読込してください。";
    toast("GitHubに上書きしました");

  }catch(e){
    els.pushStatus.innerHTML = "<span class='err'>"+escapeHTML(e.message)+"</span>";
  }
});

/* ====== CSVユーティリティ ====== */
function parseCSV(text){
  const rows=[]; let cur=['']; let inQ=false; let i=0;
  const pushCell=()=>cur.push(''); const pushRow=()=>{ rows.push(cur); cur=['']; };
  while(i<text.length){
    const ch=text[i];
    if(ch=='"'){ const nx=text[i+1]; if(inQ&&nx=='"'){ cur[cur.length-1]+='"'; i+=2; continue; } inQ=!inQ; i++; continue; }
    if(!inQ && ch==','){ pushCell(); i++; continue; }
    if(!inQ && (ch=='\n'||ch=='\r')){ if(ch=='\r'&&text[i+1]=='\n') i++; pushRow(); i++; continue; }
    cur[cur.length-1]+=ch; i++;
  }
  rows.push(cur);
  if(rows.length && rows[0][0] && rows[0][0].charCodeAt(0)===0xFEFF){ rows[0][0]=rows[0][0].slice(1); }
  return rows;
}

function renderPreview(rows){
  const table=document.createElement("table"); const thead=document.createElement("thead"); const tbody=document.createElement("tbody");
  const thTr=document.createElement("tr"); (rows[0]||[]).forEach(h=>{ const th=document.createElement("th"); th.textContent=h; thTr.appendChild(th);}); thead.appendChild(thTr);
  rows.slice(1,101).forEach(r=>{ const tr=document.createElement("tr"); r.forEach(c=>{ const td=document.createElement("td"); td.textContent=c; tr.appendChild(td); }); tbody.appendChild(tr); });
  table.appendChild(thead); table.appendChild(tbody);
  document.querySelector("#preview").innerHTML=""; document.querySelector("#preview").appendChild(table);
}

/* ====== ステータス/トースト ====== */
function setStatus(text, ok=false){ els.status.textContent=text; els.status.className= ok? "ok muted":"muted"; }
function setError(text){ els.message.innerHTML=`<span class='err'>${text}</span>`; }
function toast(text){
  const div=document.createElement("div");
  div.textContent=text;
  div.style.position="fixed"; div.style.left="50%"; div.style.bottom="28px"; div.style.transform="translateX(-50%)";
  div.style.background="#1e252f"; div.style.color="#e8eaed"; div.style.border="1px solid #2a2f3a";
  div.style.padding="10px 14px"; div.style.borderRadius="10px"; div.style.zIndex=50;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(), 2000);
}
function escapeHTML(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
</script>
</body>
</html>
