<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ガンバレジェンズ ツール（GitHub CSV自動読込版）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";margin:24px;line-height:1.6}
  h1{margin:0 0 8px}
  .muted{color:#666;font-size:14px;margin-bottom:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0}
  input[type="text"]{width:420px;max-width:100%}
  button{cursor:pointer;border:1px solid #ddd;padding:8px 12px;border-radius:6px;background:#fff}
  button:hover{background:#f5f5f5}
  .ok{color:#0a7d2e}
  .err{color:#b00020;white-space:pre-wrap}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ddd;padding:6px 8px;font-size:14px}
  th{background:#fafafa;text-align:left}
  .small{font-size:12px;color:#666}
  .pill{display:inline-block;background:#eef;border:1px solid #ccd;padding:2px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
  <h1>ガンバレジェンズ ツール</h1>
  <div class="muted">GitHub上のCSVを自動で読み込み、どこからアクセスしても同じデータを表示します。</div>

  <!-- ▼ 設定：あなたのリポジトリの Raw URL に変えてください -->
  <div class="row">
    <label for="rawUrl"><strong>CSV Raw URL</strong>（編集可）</label>
    <input id="rawUrl" type="text"
      value="https://raw.githubusercontent.com/mikaeru222/ganba-legends-tool/main/data.csv" />
    <button id="reloadBtn">最新を再読込</button>
    <span id="status" class="small"></span>
  </div>

  <div class="row">
    <label><span class="pill">フォールバック</span> ローカルCSVを読み込む</label>
    <input id="filePicker" type="file" accept=".csv" />
  </div>

  <div id="message" class="small"></div>

  <div id="app">
    <!-- あなたの既存UIがある場合はここに置き換えてください -->
    <h3>プレビュー（読み込んだCSVを表で表示）</h3>
    <div id="preview"></div>
  </div>

<script>
/** =========================
 *  1) GitHub CSV 自動読込（キャッシュ無効）
 * ========================= */
const $ = (q)=>document.querySelector(q);
const statusEl = $("#status");
const msgEl = $("#message");
const previewEl = $("#preview");
const urlInput = $("#rawUrl");
const reloadBtn = $("#reloadBtn");
const filePicker = $("#filePicker");

/** 起動時：自動でGitHub CSVを取得 */
document.addEventListener("DOMContentLoaded", () => {
  autoLoadFromGitHub();
});

/** 再読込ボタン */
reloadBtn.addEventListener("click", () => {
  autoLoadFromGitHub(true);
});

/** ローカルCSVフォールバック */
filePicker.addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  try {
    const text = await file.text();
    applyCSVText(text, { source: "local", name: file.name });
  } catch (err) {
    showError("ローカルCSVの読み込みに失敗しました。\n" + err);
  } finally {
    filePicker.value = "";
  }
});

/** GitHubから取得（?t=timestamp でキャッシュ回避） */
async function autoLoadFromGitHub(force=false) {
  const baseUrl = (urlInput.value || "").trim();
  if (!baseUrl) {
    showError("Raw URL が空です。正しいURLを設定してください。");
    return;
  }
  const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
  setStatus("GitHubから取得中…");
  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    applyCSVText(text, { source: "github", url: baseUrl });
  } catch (err) {
    showError("GitHub CSVの取得に失敗しました。\n" +
              "URL: " + baseUrl + "\n" + err + "\n\n" +
              "・URLが正しいか（raw.githubusercontent.com か）\n" +
              "・リポジトリに data.csv が存在するか\n" +
              "・数十秒の反映待ちが必要な場合があります");
  }
}

/** ステータス表示 */
function setStatus(text, ok=false) {
  statusEl.textContent = text || "";
  statusEl.className = ok ? "small ok" : "small";
}
function showError(text) {
  msgEl.innerHTML = `<div class="err">${escapeHTML(text)}</div>`;
  setStatus("エラー", false);
}

/** =========================
 *  2) CSVのパース & 画面反映
 * ========================= */

/** CSVをテキストで受けとり → パース → 表示 → アプリへ渡す */
function applyCSVText(text, meta) {
  const rows = parseCSV(text);
  if (!rows.length) {
    showError("CSVが空のようです。");
    return;
  }
  msgEl.innerHTML = renderMeta(meta, rows);
  renderTable(rows, previewEl);
  // ▼ ここであなたのアプリ本体に渡す
  applyData(rows);
  setStatus(meta.source === "github" ? "GitHubから最新を取得しました" : "ローカルCSVを読み込みました", true);
}

/** あなたのアプリ：読み込んだ2次元配列 rows を使ってUIや内部状態を更新 */
function applyData(rows) {
  // 例）最初の行をヘッダとして、以降をデータとして使う
  const [header, ...data] = rows;
  // TODO: ここで既存のロジックに合わせて data を反映
  // （パターンの検知／管理画面の更新など）
  // console.log({ header, data });
}

/** CSVプレビュー用の表を描画（単純表示） */
function renderTable(rows, container) {
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");

  // ヘッダ
  const thTr = document.createElement("tr");
  rows[0].forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    thTr.appendChild(th);
  });
  thead.appendChild(thTr);

  // 本体
  rows.slice(1).forEach(r => {
    const tr = document.createElement("tr");
    r.forEach(c => {
      const td = document.createElement("td");
      td.textContent = c;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  table.appendChild(thead);
  table.appendChild(tbody);
  container.innerHTML = "";
  container.appendChild(table);
}

/** 取得情報の表示 */
function renderMeta(meta, rows){
  const info = [];
  if (meta.source === "github") {
    info.push(`読み込み元：GitHub（<code>${escapeHTML(meta.url)}</code>）`);
  } else if (meta.source === "local") {
    info.push(`読み込み元：ローカル（<code>${escapeHTML(meta.name||"")}</code>）`);
  }
  info.push(`行数：${rows.length}（ヘッダ含む）`);
  info.push(`更新：${new Date().toLocaleString()}`);
  return `<div>${info.join(" / ")}</div>`;
}

/** シンプルCSVパーサ（ダブルクォート対応・改行対応） */
function parseCSV(text) {
  const rows = [];
  let cur = [''];
  let inQuotes = false;
  let i = 0;

  const pushCell = () => { cur.push(''); };
  const pushRow  = () => { rows.push(cur); cur = ['']; };

  while (i < text.length) {
    const ch = text[i];

    if (ch === '"') {
      const next = text[i + 1];
      if (inQuotes && next === '"') {
        cur[cur.length - 1] += '"'; // 連続の二重引用符 -> エスケープされた1個
        i += 2;
        continue;
      }
      inQuotes = !inQuotes;
      i++;
      continue;
    }

    if (!inQuotes && ch === ',') {
      pushCell();
      i++;
      continue;
    }

    if (!inQuotes && (ch === '\n' || ch === '\r')) {
      // CRLF / LF をまとめて処理
      // 直前が CR で今が LF の場合はスキップ
      if (ch === '\r' && text[i+1] === '\n') i++;
      pushRow();
      i++;
      continue;
    }

    cur[cur.length - 1] += ch;
    i++;
  }
  // 最終セル・行
  rows.push(cur);

  // 先頭が空配列のケースなどを調整（BOM除去）
  if (rows.length && rows[0].length && rows[0][0].charCodeAt(0) === 0xFEFF) {
    rows[0][0] = rows[0][0].slice(1);
  }
  return rows;
}

/** ユーティリティ */
function escapeHTML(s) {
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
</script>
</body>
</html>
